from selenium import webdriver  # –ò–º–ø–æ—Ä—Ç –≥–ª–∞–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Selenium
from selenium.webdriver.common.by import By  # –ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ By –¥–ª—è –ø–æ–∏—Å–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ —Ä–∞–∑–Ω—ã–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º (CSS, ID, XPATH)
from selenium.webdriver.support.ui import WebDriverWait  # –ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —è–≤–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏–π
from selenium.webdriver.support import expected_conditions as EC  # –ò–º–ø–æ—Ä—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏–π
from bs4 import BeautifulSoup  # –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ BeautifulSoup –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
import pandas as pd  # –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Pandas –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
import time  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è time –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞—É–∑
import random  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è random –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–∞—É–∑
import os  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è os –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞)
import json  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è json –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
URL = 'https://–∞–¥—Ä–µ—Å_—Å—Ç—Ä–∞–Ω–∏—Ü—ã_–±–∏—Ä–∂–∏.com'  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL-–∞–¥—Ä–µ—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–∏—Ä–∂–∏
PREV_DATA_FILE = 'previous_data.json'  # –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ü–∏–∫–ª–∞
TABLE_SELECTOR = (By.TAG_NAME, 'table')  # –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∏—Å–∫–∞: –∏—â–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ —Ç–µ–≥—É <table> (–õ–£–ß–®–ï: By.ID, By.CLASS_NAME)

# --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

def setup_driver():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç Selenium WebDriver."""
    options = webdriver.ChromeOptions()  # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞ Chrome
    options.add_argument('--headless')  # –î–æ–±–∞–≤–ª—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ –±–µ–∑–≥–æ–ª–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–±–µ–∑ –≥—Ä–∞—Ñ–∏–∫–∏)
    options.add_argument('--no-sandbox')  # –î–æ–±–∞–≤–ª—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ Linux-—Å–∏—Å—Ç–µ–º–∞—Ö
    options.add_argument('--disable-dev-shm-usage')  # –î–æ–±–∞–≤–ª—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Å—Ä–µ–¥–∞—Ö —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é
    options.add_argument('user-agent=Mozilla/5.0...')  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º User-Agent –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞

    driver = webdriver.Chrome(options=options)  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebDriver (Chrome) —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏
    return driver  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –¥—Ä–∞–π–≤–µ—Ä–∞

def fetch_current_data(driver, url):
    """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Selenium –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏, –æ–∂–∏–¥–∞–Ω–∏—è, –∏ BeautifulSoup –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞."""
    try:
        driver.get(url)  # –ó–∞–≥—Ä—É–∂–∞–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π URL
        print("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...")

        # 1. –Ø–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (Selenium): –ñ–¥–µ–º –¥–æ 10 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —ç–ª–µ–º–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
        WebDriverWait(driver, 10).until(
            EC.presence_of_element_located(TABLE_SELECTOR)
        )

        # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ HTML (Selenium): –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å—å HTML-–∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –µ–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        html_content = driver.page_source

        # 3. –ü–∞—Ä—Å–∏–Ω–≥ (BeautifulSoup): –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç BeautifulSoup –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ HTML
        soup = BeautifulSoup(html_content, 'html.parser')

        # –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –ø–æ–º–æ—â—å—é BeautifulSoup (–∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ—Ç –∂–µ —Å–µ–ª–µ–∫—Ç–æ—Ä)
        table = soup.find(TABLE_SELECTOR[1]) # –í TABLE_SELECTOR[1] –Ω–∞—Ö–æ–¥–∏—Ç—Å—è 'table'

        if not table:
            print("–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.")
            return pd.DataFrame() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π DataFrame

        # 4. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Pandas): –ò—Å–ø–æ–ª—å–∑—É–µ–º Pandas –¥–ª—è –ø—Ä—è–º–æ–≥–æ —á—Ç–µ–Ω–∏—è HTML-—Ç–∞–±–ª–∏—Ü—ã
        # –ü–µ—Ä–µ–¥–∞–µ–º Pandas —Ç–æ–ª—å–∫–æ HTML-–∫–æ–¥ *–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π* —Ç–∞–±–ª–∏—Ü—ã, –∞ –Ω–µ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        dfs = pd.read_html(str(table))
        current_df = dfs[0]  # pd.read_html –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç

        # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ —Å—Ç–æ–ª–±—Ü—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—à–µ–π —Ç–∞–±–ª–∏—Ü–µ–π
        # –ò–ù–ê–ß–ï Pandas –Ω–µ —Å–º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –∏—Ö –≤ check_for_changes
        current_df.columns = ['Asset', 'Price', 'Volume', 'Change', 'Time']

        return current_df  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º DataFrame —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏/–ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return pd.DataFrame()  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π DataFrame –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏

# --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–ê–ù–ù–´–ú–ò ---

def get_previous_data(file_path):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ü–∏–∫–ª–∞ –∏–∑ JSON-—Ñ–∞–π–ª–∞ –≤ DataFrame."""
    if os.path.exists(file_path):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
        try:
            return pd.read_json(file_path)  # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON –≤ DataFrame
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {file_path}: {e}")
            return pd.DataFrame()  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π DataFrame –ø—Ä–∏ –æ—à–∏–±–∫–µ —á—Ç–µ–Ω–∏—è
    return pd.DataFrame()  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π DataFrame, –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç

def save_data(df, file_path):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–π DataFrame –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞."""
    df.to_json(file_path, orient='records', indent=4)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º DataFrame –≤ JSON-—Ñ–∞–π–ª

def check_for_changes():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö."""
    driver = setup_driver()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebDriver

    prev_df = get_previous_data(PREV_DATA_FILE)  # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ü–∏–∫–ª–∞
    current_df = fetch_current_data(driver, URL)  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–∞–π—Ç–∞

    driver.quit()  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

    if current_df.empty:  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
        print("–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã, –ø—Ä–æ–ø—É—Å–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.")
        return

    # 1. –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    if prev_df.empty:
        print("‚úÖ –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.")
        save_data(current_df, PREV_DATA_FILE)
        return

    # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ ('Asset') –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∏–Ω–¥–µ–∫—Å–∞
    try:
        prev_df = prev_df.set_index('Asset')
        current_df = current_df.set_index('Asset')
    except KeyError:
        print("‚ùå –û—à–∏–±–∫–∞: –°—Ç–æ–ª–±–µ—Ü 'Asset' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤.")
        return

    # 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–û–±—â–∏–µ –∞–∫—Ç–∏–≤—ã)
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º DataFrame –ø–æ –∏–Ω–¥–µ–∫—Å—É (Asset) –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
    merged_df = prev_df.join(current_df, how='inner', lsuffix='_prev', rsuffix='_curr')
    changes_found = False

    # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–º—É DataFrame –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω—ã
    for index, row in merged_df.iterrows():
        prev_price = row.get('Price_prev')
        curr_price = row.get('Price_curr')

        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ —è–≤–ª—è—é—Ç—Å—è —á–∏—Å–ª–æ–≤—ã–º–∏
        if pd.notna(prev_price) and pd.notna(curr_price):
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ float)
            if abs(float(curr_price) - float(prev_price)) > 0.001:
                print(f"‚ùó –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ê–∫—Ç–∏–≤ {index} (Price): {prev_price} -> {curr_price}")
                changes_found = True

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ –∞–∫—Ç–∏–≤—ã
    new_assets = current_df.index.difference(prev_df.index)  # –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –Ω–æ–≤–æ–º, –Ω–æ –Ω–µ—Ç –≤ —Å—Ç–∞—Ä–æ–º
    if not new_assets.empty:
        print(f"‚úÖ –ù–û–í–´–ï –ê–ö–¢–ò–í–´: {list(new_assets)}")
        changes_found = True

    # 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤
    if not changes_found:
        print("–î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    save_data(current_df.reset_index(), PREV_DATA_FILE)

# --- –¶–ò–ö–õ –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê ---
if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–∏—Ä–∂–∏...")

    MONITOR_INTERVAL = 60  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

    while True:
        check_for_changes()  # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        print(f"\n--- –ü–∞—É–∑–∞ {MONITOR_INTERVAL} —Å–µ–∫—É–Ω–¥ ---")
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞ –∏ –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        time.sleep(MONITOR_INTERVAL + random.uniform(1, 5))

        